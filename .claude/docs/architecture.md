# Architecture Overview

## Storage Architecture

The application uses **Cloudflare-native storage services** for optimal performance:

### Cloudflare Images (Image Storage)
- **Collection**: `images`
- **Features**: Automatic format optimization (WebP, AVIF), dynamic transformations, global CDN
- **URL Format**: `https://imagedelivery.net/<hash>/<imageId>/public`
- **Replaces**: Sharp image processing

### Cloudflare Stream (Video Storage)
- **Collections**: `frames` (video frames only)
- **Features**: Automatic transcoding, HLS streaming, thumbnail generation, MP4 downloads
- **URL Format**:
  - Thumbnails: `https://customer-<code>.cloudflarestream.com/<videoId>/thumbnails/thumbnail.jpg`
  - MP4: `https://customer-<code>.cloudflarestream.com/<videoId>/downloads/default.mp4`
- **Replaces**: FFmpeg thumbnail generation

### R2 Native Bindings (Audio & Generic Files)
- **Collections**: `meditations`, `music`, `lessons`, `files`
- **Features**: Direct bucket access, high performance
- **URL Format**: `https://<PUBLIC_ASSETS_URL>/<collection>/<filename>`
- **Configuration**: Via `wrangler.toml` bindings (no S3-compatible API)

### Development Environment
- **Automatic Fallback**: Local file storage used when Cloudflare credentials not configured
- **No Setup Required**: Development works out of the box without Cloudflare accounts

## Route Structure
- `src/app/(frontend)/` - Public-facing Next.js pages
- `src/app/(payload)/` - Payload CMS admin interface and API routes
- `src/app/(payload)/api/` - Auto-generated API endpoints including GraphQL

## Collections

### Access & User Management
- **Managers** (`src/collections/access/Managers.ts`) - Authentication-enabled admin users with email/password authentication, admin toggle for complete access bypass, and granular collection/locale-based permissions array
- **Clients** (`src/collections/access/Clients.ts`) - API client management with authentication keys, usage tracking, granular collection/locale-based permissions, and high-usage alerts

### Content Collections
- **Pages** (`src/collections/content/Pages.ts`) - Rich text content with embedded blocks using Lexical editor, author relationships, tags, auto-generated slugs, and publish scheduling
- **Meditations** (`src/collections/content/Meditations.ts`) - Guided meditation content with audio files, tags, metadata, frame relationships with timestamps, and locale-specific content filtering
- **Music** (`src/collections/content/Music.ts`) - Background music tracks with direct audio upload, tags, and metadata (title and credit fields are localized)
- **Lessons** (`src/collections/content/Lessons.ts`) - Meditation lessons (also called "Path Steps" in admin UI) with audio upload, panels array for content sections, unit selection (Unit 1-4), step number, icon, optional meditation relationship, and rich text article field

### Resource Collections
- **Images** (`src/collections/resources/Images.ts`) - Image storage using Cloudflare Images with automatic format optimization (WebP, AVIF), dynamic transformations, tags, credit info, and virtual `url` field for Cloudflare CDN delivery
- **Narrators** (`src/collections/resources/Narrators.ts`) - Meditation guide profiles with name, gender, and slug
- **Authors** (`src/collections/resources/Authors.ts`) - Article author profiles with localized name, title, description, countryCode, yearsMeditating, and profile image
- **ExternalVideos** (`src/collections/resources/ExternalVideos.ts`) - External video content with thumbnails, URLs, subtitles, and categorization

### System Collections
- **Frames** (`src/collections/system/Frames.ts`) - Mixed media upload (images/videos) with Cloudflare Images for images and Cloudflare Stream for videos, automatic thumbnail generation, virtual fields (`thumbnailUrl`, `streamMp4Url`), tags filtering, and imageSet selection
- **Files** (`src/collections/system/Files.ts`) - Generic file storage using R2 native bindings, supporting PDFs, audio, video, and images with owner relationships for cascade deletion and virtual `url` field for R2 URLs

### Tag Collections
- **MediaTags** (`src/collections/tags/MediaTags.ts`) - Tag system for image files with slug-based identification
- **MeditationTags** (`src/collections/tags/MeditationTags.ts`) - Tag system for meditations with bidirectional relationships (title field is localized)
- **MusicTags** (`src/collections/tags/MusicTags.ts`) - Tag system for music tracks with bidirectional relationships (title field is localized)
- **PageTags** (`src/collections/tags/PageTags.ts`) - Tag system for pages with bidirectional relationships (title field is localized)

### Plugin-Generated Collections
- **Forms** (Auto-generated by Form Builder plugin) - Form definitions with field configuration and submission handling
- **Form Submissions** (Auto-generated by Form Builder plugin) - Stored form submission data

## Key Configuration Files
- `src/payload.config.ts` - Main Payload CMS configuration with collections, database, email, and plugins
- `next.config.mjs` - Next.js configuration with Payload integration
- `src/payload-types.ts` - Auto-generated TypeScript types (do not edit manually)
- `tsconfig.json` - TypeScript configuration with path aliases
- `eslint.config.mjs` - ESLint configuration for code quality
- `vitest.config.mts` - Vitest configuration for integration tests
- `playwright.config.ts` - Playwright configuration for E2E tests
- `src/lib/richEditor.ts` - Rich text editor configuration presets

## Component Architecture
- `src/components/AdminProvider.tsx` - Payload admin UI provider component (wraps with ProjectProvider)
- `src/components/ErrorBoundary.tsx` - React error boundary for error handling
- `src/app/(payload)/` - Payload CMS admin interface and API routes
- `src/app/(frontend)/` - Public-facing Next.js pages

## Sentry Integration Files
- `src/instrumentation.ts` - Server-side Sentry instrumentation
- `src/instrumentation-client.ts` - Client-side Sentry instrumentation
- `src/sentry.server.config.ts` - Sentry server configuration
- `src/sentry.edge.config.ts` - Sentry edge runtime configuration
- `src/app/global-error.tsx` - Global error boundary with Sentry integration

## Rich Text Editor Configuration

The application uses Lexical editor with two configuration presets:

### Basic Rich Text Editor (`basicRichTextEditor`)
- **Features**: Bold, Italic, Link, and InlineToolbar
- **Usage**: Simple text fields that need minimal formatting

### Full Rich Text Editor (`fullRichTextEditor`)
- **Features**: All basic formatting plus:
  - Unordered and Ordered Lists
  - Blockquote
  - Headings (H1, H2)
  - Relationship feature for linking to meditations, music, pages, and forms
  - Blocks feature for embedding custom block components
- **Usage**: Page content and other rich content areas

Configuration located in `src/lib/richEditor.ts`

## Data Import & Migrations

The system includes import scripts for migrating content from external sources into Payload CMS.

**For detailed migration documentation, usage examples, and troubleshooting**, see [migration/README.md](../../migration/README.md).

**Available Import Scripts**:
- **Storyblok Import** - Migrates Path Steps from Storyblok CMS to Lessons collection
- **WeMeditate Import** - Imports authors, categories, and pages from Rails PostgreSQL database
- **Meditations Import** - Imports meditation content from legacy database

All scripts follow consistent patterns: resilient error handling, comprehensive dry-run mode, shared utilities, and detailed reporting.
